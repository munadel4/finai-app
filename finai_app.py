import streamlit as st
import tempfile
import os
from fpdf import FPDF
import base64

st.markdown(
    """
    <style>
    body, .stApp {
        direction: rtl;
        text-align: right;
        font-family: 'Arial', sans-serif;
    }
    </style>
    """,
    unsafe_allow_html=True
)
st.set_page_config(page_title="FinAI - Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ", layout="centered")

# --- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ---
st.title("FinAI - Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙÙŠ Ø§Ù„ØªÙ…ÙˆÙŠÙ„")
st.subheader("Ø¥Ø¹Ø¯Ø§Ø¯: Ø­Ù„ÙŠÙ…Ø© Ø¬ÙŠØªØ§ÙˆÙŠ")

# --- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
st.markdown("### ØªÙ‚ÙŠÙŠÙ… Ø·Ù„Ø¨ Ù‚Ø±Ø¶ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ")

income = st.number_input("Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø´ÙŠÙƒÙ„)", min_value=0.0, step=10.0)
loan_amount = st.number_input("Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø±Ø¶ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ø´ÙŠÙƒÙ„)", min_value=0.0, step=10.0)
commitments = st.number_input("Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© (Ø´ÙŠÙƒÙ„)", min_value=0.0, step=10.0)
years = st.selectbox("Ø¹Ø¯Ø¯ Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø³Ø¯Ø§Ø¯", [1, 2, 3, 4, 5, 6, 7, 8, 9, 10])

generate_report = False
analysis_result = ""
tip = ""

# --- ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ù‡Ù„ÙŠØ© ---
if st.button("ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©"):
    if income == 0:
        st.error("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¯Ø®Ù„ Ø´Ù‡Ø±ÙŠ Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.")
    else:
        monthly_payment = loan_amount / (years * 12)
        dti = (commitments + monthly_payment) / income

        st.markdown("#### Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„:")

        if dti < 0.3:
            analysis_result = (
                f"DTI = {dti:.2f} â€” Ù…Ù…ØªØ§Ø² ğŸ‘Œ\n\n"
                "Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø®Ù„ Ù…Ù†Ø®ÙØ¶Ø© Ø¬Ø¯Ø§Ù‹ØŒ Ù…Ù…Ø§ ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ Ù‚Ø¯Ø±Ø© Ù…Ø§Ù„ÙŠØ© Ø¬ÙŠØ¯Ø© Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù‚Ø±Ø¶. "
                "ÙŠÙØªÙˆÙ‚Ø¹ Ø£Ù† ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ§ÙÙ‚Ø© Ø³Ø±ÙŠØ¹Ø© Ù…Ù† Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ù…ÙˆÙ„Ø© Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©."
            )
            st.success(analysis_result)
        elif dti < 0.45:
            analysis_result = (
                f"DTI = {dti:.2f} â€” Ø¬ÙŠØ¯ âœ…\n\n"
                "Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø®Ù„ Ù…Ù‚Ø¨ÙˆÙ„Ø©. Ù‚Ø¯ ØªØ·Ù„Ø¨ Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø¨Ø¹Ø¶ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø£Ùˆ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ù…ØµØ¯Ø± Ø§Ù„Ø¯Ø®Ù„."
            )
            st.info(analysis_result)
        elif dti < 0.6:
            analysis_result = (
                f"DTI = {dti:.2f} â€” Ù…ØªÙˆØ³Ø· âš ï¸\n\n"
                "Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙŠÙ† Ù…Ø±ØªÙØ¹Ø© Ù†Ø³Ø¨ÙŠÙ‹Ø§. ÙŠÙÙ†ØµØ­ Ø¨ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø£Ùˆ Ø®ÙØ¶ Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø±Ø¶ Ù„ØªØ­Ø³ÙŠÙ† ÙØ±Øµ Ø§Ù„Ù‚Ø¨ÙˆÙ„."
            )
            st.warning(analysis_result)
        else:
            analysis_result = (
                f"DTI = {dti:.2f} â€” Ù…Ø±ØªÙØ¹ âŒ\n\n"
                "Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙŠÙ† Ù…Ø±ØªÙØ¹Ø© Ø¬Ø¯Ù‹Ø§ØŒ Ù…Ù…Ø§ ÙŠØ¹Ø±Ø¶Ùƒ Ù„Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨. Ø­Ø§ÙˆÙ„ Ø³Ø¯Ø§Ø¯ Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø®Ø·Ø©."
            )
            st.error(analysis_result)

        generate_report = True

# --- Ø§Ù„Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ù…Ø§Ù„ÙŠØ© ---
st.markdown("### Ù†ØµÙŠØ­Ø© Ù…Ø§Ù„ÙŠØ© Ø°ÙƒÙŠØ©")
goal = st.selectbox("Ù…Ø§ Ù‡Ùˆ Ù‡Ø¯ÙÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØŸ", ["Ø§Ø¯Ø®Ø§Ø±", "Ø§Ø³ØªØ«Ù…Ø§Ø±", "Ø³Ø¯Ø§Ø¯ Ø¯ÙŠÙˆÙ†"])

if goal == "Ø§Ø¯Ø®Ø§Ø±":
    tip = (
        "- Ù‚Ù… Ø¨ØªØ®ØµÙŠØµ 20% Ù…Ù† Ø¯Ø®Ù„Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ø¯Ø®Ø§Ø± Ù…Ø³ØªÙ‚Ù„.\n"
        "- Ø§Ø³ØªØ®Ø¯Ù… Ø­Ø³Ø§Ø¨ ØªÙˆÙÙŠØ± Ø¨ÙØ§Ø¦Ø¯Ø© ØªØ±Ø§ÙƒÙÙ…ÙŠØ©.\n"
        "- Ø¶Ø¹ Ø£Ù‡Ø¯Ø§ÙÙ‹Ø§ Ù‚ØµÙŠØ±Ø© Ø§Ù„Ù…Ø¯Ù‰ (Ù…Ø«Ù„: 3 Ø£Ø´Ù‡Ø± Ø±Ø§ØªØ¨ ÙƒØ§Ø­ØªÙŠØ§Ø·ÙŠ Ø·ÙˆØ§Ø±Ø¦).\n"
        "- ØªØ¬Ù†Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¥Ù„Ø§ ÙÙŠ Ø§Ù„Ø¶Ø±ÙˆØ±Ø© Ø§Ù„Ù‚ØµÙˆÙ‰."
    )
elif goal == "Ø§Ø³ØªØ«Ù…Ø§Ø±":
    tip = (
        "- Ø§Ø¨Ø¯Ø£ Ø¨Ù…Ø¨Ø§Ù„Øº ØµØºÙŠØ±Ø© ÙÙŠ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ø³ØªØ«Ù…Ø§Ø± Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±.\n"
        "- Ù†ÙˆØ¹ Ù…Ø­ÙØ¸ØªÙƒ: Ø¬Ø²Ø¡ Ù„Ù„Ø£Ø³Ù‡Ù…ØŒ Ø¬Ø²Ø¡ Ù„Ù„ÙˆØ¯Ø§Ø¦Ø¹ØŒ ÙˆØ¬Ø²Ø¡ ÙÙŠ Ø§Ù„Ø°Ù‡Ø¨.\n"
        "- Ù„Ø§ ØªØ³ØªØ«Ù…Ø± Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø°ÙŠ Ù‚Ø¯ ØªØ­ØªØ§Ø¬Ù‡ Ø®Ù„Ø§Ù„ 6 Ø£Ø´Ù‡Ø±.\n"
        "- ØªØ§Ø¨Ø¹ Ø£Ø¯Ø§Ø¡ Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§ØªÙƒ Ø´Ù‡Ø±ÙŠÙ‹Ø§ ÙˆÙ‚Ù… Ø¨Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠØ©."
    )
else:
    tip = (
        "- Ù‚Ù… Ø¨ØªØ±ØªÙŠØ¨ Ø¯ÙŠÙˆÙ†Ùƒ Ø­Ø³Ø¨ Ø§Ù„ÙØ§Ø¦Ø¯Ø© ÙˆØ§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.\n"
        "- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© 'ÙƒØ±Ø© Ø§Ù„Ø«Ù„Ø¬' Ø£Ùˆ 'Ø§Ù„Ø§Ù†Ù‡ÙŠØ§Ø± Ø§Ù„Ø¬Ø¨Ù„ÙŠ'.\n"
        "- Ø§Ø¬Ø¹Ù„ Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø£ÙˆÙ„ÙˆÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªÙÙƒÙŠØ± ÙÙŠ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±.\n"
        "- Ù„Ø§ ØªÙ‚ØªØ±Ø¶ Ù„Ø³Ø¯Ø§Ø¯ Ù‚Ø±Ø¶ Ø³Ø§Ø¨Ù‚ØŒ ÙÙ‡Ø°Ø§ ÙŠØ²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø£Ø²Ù…Ø©."
    )

st.info("ğŸ’¡ " + tip.replace("\n", "\n\n"))

# --- ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± PDF ---
def generate_pdf(income, loan_amount, commitments, years, result, tip_text):
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", size=12)

    pdf.cell(200, 10, txt="ØªÙ‚Ø±ÙŠØ± ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù‚Ø±Ø¶ - FinAI", ln=True, align='C')
    pdf.cell(200, 10, txt="Ø¥Ø¹Ø¯Ø§Ø¯: Ø­Ù„ÙŠÙ…Ø© Ø¬ÙŠØªØ§ÙˆÙŠ", ln=True, align='R')
    pdf.ln(10)

    pdf.cell(200, 10, txt=f"Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ: {income} Ø´ÙŠÙƒÙ„", ln=True)
    pdf.cell(200, 10, txt=f"Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø±Ø¶ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: {loan_amount} Ø´ÙŠÙƒÙ„", ln=True)
    pdf.cell(200, 10, txt=f"Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©: {commitments} Ø´ÙŠÙƒÙ„", ln=True)
    pdf.cell(200, 10, txt=f"Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø³Ø¯Ø§Ø¯: {years}", ln=True)

    pdf.ln(10)
    pdf.multi_cell(0, 10, f"Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„:\n{result}")
    pdf.ln(5)
    pdf.multi_cell(0, 10, f"Ù†ØµÙŠØ­Ø© Ù…Ø§Ù„ÙŠØ©:\n{tip_text}")

    with tempfile.NamedTemporaryFile(delete=False, suffix=".pdf") as tmpfile:
        pdf.output(tmpfile.name)
        return tmpfile.name

if generate_report:
    if st.button("ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± PDF"):
        file_path = generate_pdf(income, loan_amount, commitments, years, analysis_result, tip)
        with open(file_path, "rb") as f:
            base64_pdf = base64.b64encode(f.read()).decode("utf-8")
            href = f'<a href="data:application/pdf;base64,{base64_pdf}" download="finai_report.pdf">ğŸ“„ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</a>'
            st.markdown(href, unsafe_allow_html=True)
        os.remove(file_path)

# --- ØªØ°ÙŠÙŠÙ„ ---
st.markdown("---")
st.caption("ØªØ·Ø¨ÙŠÙ‚ ØªØ¹Ù„ÙŠÙ…ÙŠ ÙŠØ¹Ø±Ø¶ Ø¯ÙˆØ± Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙÙŠ Ø§ØªØ®Ø§Ø° Ù‚Ø±Ø§Ø±Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠ.")
